### mxnet->keras

依赖：mmdnn、mxnet、tensorflow、keras

```bash
# mxnet -> IR
python -m mmdnn.conversion._script.convertToIR -f mxnet -n resnet_v1-50_8_classes-symbol.json -w resnet_v1-50_8_classes-0033.params -d douyin_mxnet_resnet50_v1 --inputShape 3,224,224
# 会生成3个文件

# IR -> keras code
python -m mmdnn.conversion._script.IRToCode -f keras --IRModelPath douyin_mxnet_resnet50_v1.pb --IRWeightPath douyin_mxnet_resnet50_v1.npy --dstModelPath converted_resnet50_v1.py
# 会生成一个代码文件

# test keras code
python -m mmdnn.conversion.examples.keras.imagenet_test -p imagenet1k-resnext-50 -s mxnet -n converted_resnet50_v1.py -w mxnet_resnext50.npy -i mmdnn/conversion/examples/data/seagull.jpg

# Save as Keras model
python -m mmdnn.conversion.examples.keras.imagenet_test -n converted_resnet50_v1 -w douyin_mxnet_resnet50_v1.npy --dump douyin_mxnet_resnet50_v1.h5

# 0.1.4版本以上只需要一个命令
mmconvert -sf mxnet -in resnet_v1-50_8_classes-symbol.json -iw resnet_v1-50_8_classes-0033.params -df keras -om douyin_mxnet_resnet50_v1_.h5 --inputShape 3,224,224
# --inputShape channels,height,width
```



#### mxnet -> IR output

```
[13:33:41] src/nnvm/legacy_json_util.cc:209: Loading symbol saved by previous version v1.3.1. Attempting to upgrade...
[13:33:41] src/nnvm/legacy_json_util.cc:217: Symbol successfully upgraded!
Warning: MXNet Parser has not supported operator null with name data.
Warning: convert the null operator with name [data] into input layer.
IR network structure is saved as [douyin_mxnet_resnet50_v1.json].
IR network structure is saved as [douyin_mxnet_resnet50_v1.pb].
IR weights are saved as [douyin_mxnet_resnet50_v1.npy].
```



#### IR -> keras code output

```
Using TensorFlow backend.
Target network code snippet is saved as [converted_resnet50_v1.py].
```



#### save as keras model output

```
Using TensorFlow backend.
Keras model file is saved as [douyin_mxnet_resnet50_v1.h5], generated by [converted_resnet50_v1.py.py] and [douyin_mxnet_resnet50_v1.npy].
```

这里有点奇怪`generated by [converted_resnet50_v1.py.py]`，如果输入-n不加.py会报找不到converted_resnet50_v1错误，但加了，输出显示有点问题。



#### 加载模型代码

```python
from tensorflow import keras
import mxnet as mx
from tensorflow.keras.layers import Add


# mxnet
# load model
sym, arg_params, aux_params = mx.model.load_checkpoint(
    "/mnt/cephfs_new_wj/vc/jiang/models/pretrain/douyin_image/v1/resnet_v1-50_8_classes", 33) # load with net name and epoch num
# mod = mx.mod.Module(symbol=sym, context=mx.cpu(), data_names=["data"], label_names=[]) # label can be empty
# mod.bind(for_training=False, data_shapes=[("data", (1, 3, 224, 224))])
# mod.set_params(arg_params, aux_params)

# # predict
# predict_stress = mod.predict(eval_iter, num_batch)


# keras
converted_model_file = '/mnt/cephfs_new_wj/vc/jiang/models/pretrain/douyin_image/v1/douyin_mxnet_resnet50_v1_.h5'
# model = keras.models.load_model(converted_model_file)
model = keras.models.load_model(converted_model_file, custom_objects={'my_add': Add})
model.summary()
```



### 参考：

- https://github.com/microsoft/MMdnn/tree/master/mmdnn/conversion/mxnet
- https://github.com/Microsoft/MMdnn/issues/58
- https://github.com/microsoft/MMdnn/issues/758