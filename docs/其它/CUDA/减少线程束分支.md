### 线程束执行特点

特性1：在一个线程束中，所有线程按照单指令多线程SIMT的方式执行，每一步执行相同的指令，但是处理的数据为私有的数据。

特性2：在硬件层面，线程的调度实际上是基于半个线程束，而不是整个线程束。（后面优化需要用到此特性）

### 为什么需要减少线程束分支

在CUDA中支持C语言的控制流，比如if…else, for ,while 等，CUDA中同样支持，但是如果一个线程束中的不同线程包含不同的控制条件，那么当我们执行到这个控制条件是就会面临不同的选择。

分支会导致线程束分化，即同一线程束内的线程产生了不同的执行路径，有的线程执行了action_a（等待action_b），有的线程执行了action_b（等待action_a），此时硬件的利用率就降低了，因此要避免线程束分支。

```cpp
if (condition) {
    action_a();
} else {
    action_b();
}
```

![img](https://tony4ai-1251394096.cos.ap-hongkong.myqcloud.com/blog_images/CUDA-F-3-2-%E7%90%86%E8%A7%A3%E7%BA%BF%E7%A8%8B%E6%9D%9F%E6%89%A7%E8%A1%8C%E7%9A%84%E6%9C%AC%E8%B4%A8-P1/3_12.png)

### 如何减少分支

#### 根据线程的索引划分分支

如果我们能将半个线程束中连续的16个线程划分到同一个分支中，那么硬件就能同时执行分支结构的两个不同条件的分支块。（依据线程束特性2：半线程束调度），如：

```cpp
if ((thread_id % 32 < 16)) {
    action_a();
} else {
    action_b();
}
```

当缓存大小与线程束需要获取的数据大小相同同时数据在内存上分布也是连续的，这样也有助于合并访存。

参考：

- [https://face2ai.com/cuda-f-3-4-%e9%81%bf%e5%85%8d%e5%88%86%e6%94%af%e5%88%86%e5%8c%96/](https://face2ai.com/cuda-f-3-4-避免分支分化/)